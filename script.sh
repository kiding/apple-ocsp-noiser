#!/bin/zsh
set -Eeuo pipefail

ASN1_PREFIX=$'\x30\x4E\x30\x4C\xA0\x03\x02\x01\x00\x30\x45\x30\x43\x30\x41\x30\x09\x06\x05\x2B\x0E\x03\x02\x1A\x05\x00\x04\x14\x33\x81\xD1\xEF\xDB\x68\xB0\x85\x21\x4D\x2E\xEF\xAF\x8C\x4A\x69\x64\x3C\x2A\x6C\x04\x14\x57\x17\xED\xA2\xCF\xDC\x7C\x98\xA1\x10\xE0\xFC\xBE\x87\x2D\x2C\xF2\xE3\x17\x54\x02\x08'
URL_HOST='http://ocsp.apple.com'
URL_RESPONDER='ocsp04-devid01' # or ocsp-devid01
KNOWN_SERIALS=(
  $'\x19\xC6\x0C\x0C\x77\xEA\x61\xD2'
  $'\x77\x25\xDB\xFF\x31\xBD\xEF\xCD'
  $'\x57\x9C\x99\xC0\x8F\x66\x2A\x7C'
  $'\x75\xA6\x01\x1E\x17\x0D\x99\xC3'
  $'\x57\x8C\x60\x42\xC4\xFB\xF6\xB4'
  $'\x48\x1B\x3D\xEA\xF9\x5B\x5E\x32'
  $'\x03\xF4\x3B\xA1\x7F\x73\x96\x0F'
  $'\x5B\x58\xE8\x1C\x57\xA2\xAB\xA1'
  $'\x00\x83\xD3\x24\xD4\xED\x43\xA2'
  $'\x1D\x96\xBB\xEF\x6C\xE7\xB6\x38'
  $'\x51\x62\x03\xD8\x7D\x3F\xE5\xB6'
  $'\x3D\x7C\xA5\xDD\xA5\xD3\xAF\x94'
  $'\x06\xC7\x94\x21\x6C\x7A\xA9\x30'
  $'\x11\x48\xDF\xC7\x64\xDB\x01\x5D'
  $'\x75\x8E\xF3\x40\x27\x52\xDE\x87'
  $'\x34\xC8\x25\xD8\x79\x0A\x6E\xFB'
  $'\x50\x79\x45\xB5\xA0\xD1\x3B\x28'
  $'\x18\xCA\xA9\xBE\x8D\xF7\xA7\xC0'
  $'\x40\xB9\x02\xCE\x9F\x1E\xAA\x55'
  $'\x0C\xAB\x1E\x0B\xDE\x31\xC9\x29'
  $'\x3B\x21\x43\xB5\xDA\x74\x2C\x09'
  $'\x2B\xE0\x38\xCF\x65\x6A\xC2\xBA'
  $'\x5E\xFE\x81\x6E\xEC\x3D\x8B\x62'
  $'\x1B\x69\x7D\xF3\xDD\x6B\xCA\xD7'
  $'\x23\xAD\x88\x3A\xF3\x9D\xDD\x55'
  $'\x53\xE8\x19\x42\xC2\x36\x2C\x3B'
  $'\x1B\xBD\xD4\xBB\xB1\x19\x30\xD7'
  $'\x04\x92\x63\xF5\x74\x32\xD1\xE5'
  $'\x56\x77\xC9\xE8\x6C\x3D\xE6\x6A'
  $'\x5D\x8C\x36\xBE\x31\x50\x3D\xA2'
  $'\x24\xFC\xF9\xF5\x58\x32\x05\xC6'
  $'\x04\xB6\xC2\xDC\x29\xEF\xE3\xBD'
  $'\x4D\x3C\x3A\xBD\x73\x5B\x09\x50'
  $'\x3F\x04\x2E\x8D\x55\xA6\xC7\x8D'
  $'\x59\x67\xF4\xBD\x87\x21\xDF\x69'
)

while true; do
  if [ $((RANDOM % 2)) -eq 0 ]; then
    RANDOM_SERIAL=$(dd if=/dev/random count=8 bs=1 2>/dev/null)
    ASN1_SERIAL="$RANDOM_SERIAL"
  else
    DICE=$((RANDOM % ${#KNOWN_SERIALS} + 1))
    ASN1_SERIAL="${KNOWN_SERIALS[$DICE]}"
  fi
  echo -n "$ASN1_SERIAL" | xxd -p

  ASN1_BASE64=$(echo -n "$ASN1_PREFIX$ASN1_SERIAL" | base64)
  URL_ASN1=$(sed -e 's/+/%2B/g' -e 's/\//%2F/g' -e 's/=/%3D/g' <<< "$ASN1_BASE64")
  curl -s "$URL_HOST/$URL_RESPONDER/$URL_ASN1" \
    -H 'Accept: */*' \
    -H 'Accept-Language: en-us' \
    -H 'Connection: keep-alive' \
    -H 'Accept-Encoding: gzip, deflate' \
    -H 'User-Agent: com.apple.trustd/2.0' \
    -o /dev/null

  TIMER=$((RANDOM % 300))
  echo "Sleeping ${TIMER}s..."
  sleep "$TIMER"
done
